<div id="chatbot-widget" class="fixed bottom-6 left-6 w-80 z-50 shadow-2xl border-4 border-blue-600 rounded-xl">
  <div id="chatbot-header"
       onclick="toggleChatbot()"
       class="bg-blue-600 text-white px-6 py-4 rounded-t-xl cursor-pointer flex items-center text-lg font-bold tracking-wide shadow-lg"
       style="transition: background 0.2s;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8a9 9 0 0118 0z" />
    </svg>
    Virtual Assistant
  </div>
  <div id="chatbot-body" class="bg-white shadow-lg max-h-96 overflow-y-auto p-4 border-t-2 border-blue-600 rounded-b-xl">
    <div id="chatbot-history" class="space-y-4"></div>
    <div class="mt-4 flex space-x-2">
      <input type="text" id="chatbot-input"
             placeholder="Type your question..."
             class="flex-1 px-3 py-2 border-2 border-blue-600 rounded-md text-sm focus:outline-none focus:ring focus:border-blue-400"
             required>
      <button id="chatbot-send"
              class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-md font-semibold shadow transition duration-200">
        Send
      </button>
    </div>
  </div>
</div>

<script>
  // Auto opens chat since the begining
  document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("chatbot-body").classList.remove("hidden");
    fetchHistory(); // Shows history after load
  });

  function toggleChatbot() {
    const body = document.getElementById("chatbot-body");
    body.classList.toggle("hidden");
  }

  document.getElementById("chatbot-send").onclick = function(e) {
    e.preventDefault();
    sendChatbotMsg();
  };
  document.getElementById("chatbot-input").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      sendChatbotMsg();
    }
  });

  function sendChatbotMsg() {
    const input = document.getElementById('chatbot-input');
    const message = input.value.trim();
    if (!message) return;
    input.value = "";
    fetch('/chatbot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: message })
    })
    .then(response => response.json())
    .then(data => {
      updateChatHistory(data.history);
    });
  }

  function updateChatHistory(history) {
    const historyDiv = document.getElementById("chatbot-history");
    historyDiv.innerHTML = "";
    (history || []).forEach(pair => {
      historyDiv.innerHTML += `
        <div>
          <p class="text-sm text-gray-700"><span class="font-semibold">You:</span> ${escapeHTML(pair.user)}</p>
          <p class="text-sm text-gray-700"><span class="font-semibold">Assistant:</span> ${pair.bot}</p>
        </div>
      `;
    });
    historyDiv.scrollTop = historyDiv.scrollHeight;
  }

  function fetchHistory() {
    // Sends an empty request to open the widget
    fetch('/chatbot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: "" })
    })
    .then(response => response.json())
    .then(data => {
      updateChatHistory(data.history);
    });
  }

  function escapeHTML(text) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
  }
</script>
